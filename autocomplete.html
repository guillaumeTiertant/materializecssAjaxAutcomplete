<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title></title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

        <style>
            .autocomplete-content {
                width: 100% !important;
                left: 0 !important;
            }
            
        </style>
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        
        <div class="row">
            <div class="input-field col s12">
              <input type="text" id="autocomplete-input" class="autocomplete">
              <label for="autocomplete-input">Autocomplete</label>
            </div>
        </div>

        <script>
            var openSave = () => {}

            var updateDataByAjax = () => {
                var search = $('#autocomplete-input').val()
                var autocompleteInstance = M.Autocomplete.getInstance($('#autocomplete-input'));
        
                if (search.length > 1) {
                    $.ajax({
                        url: "https://geo.api.gouv.fr/communes", // the endpoint
                        type: "GET", // http method
                        traditional: true,
                        data: !!search
                            ? {nom: search, fields: "nom", format: "json"}
                            : {fields: "nom", format: "json"},
                        headers: {
                            "Accept": "application/json",
                            "Content-type": "application/json",
                        },
                        // handle a successful response
                        success: function (json) {
                            let data = json.sort((a, b) => {
                                if (a.nom > b.nom) return 1;
                                if (a.nom < b.nom) return -1;
                                return 0;
                            })

                            data = json.reduce((acc, o) => {
                                return {...acc, [o.nom]: null}
                            }, {});

                            autocompleteInstance.updateData(data)
                            autocompleteInstance.open = openSave
                            autocompleteInstance.open()
                            autocompleteInstance.open = () => {}
                        }
                    })
                } else {
                    autocompleteInstance.close()
                }
            }

            var elem = document.querySelector('#autocomplete-input')
            var autocompleteInstance = M.Autocomplete.init(elem, {
                data: [],
                limit: Infinity,
                minLength: 1
            })
            
            // Prevent execution of open function before update data
            openSave = autocompleteInstance.open
            autocompleteInstance.open = () => {}


            $(`#autocomplete-input`).on('keyup focus', function(e) {
                if (e.which === 13) {
                    return false
                }
                let value = e.target.value
                if (value.length > 1) {
                    let timeout = setTimeout(() => {
                    if ($(this).val() === value) {
                        updateDataByAjax()
                    }
                    clearTimeout(timeout)
                    }, 300);
                }
            })

            $(`#autocomplete-input`).on('focusin', function(e) {
                // Clear input on focus.
                var autocompleteInput = document.getElementById(this.id);
                autocompleteInput.value = null;
            })

            $(`#autocomplete-input`).on('focusout', function(e) {
                /*
                    Clear input on focus out if value is not in autocomplete data
                */
                var autocompleteInput = document.getElementById(this.id);
                let autocompleteInstance = M.Autocomplete.getInstance(elem);
                let data = Object.keys(autocompleteInstance.options.data).map(o => o.toLowerCase())
                if (!data.includes(autocompleteInput.value.toLowerCase())) {
                    autocompleteInput.value = null;
                } else {
                    autocompleteInput.value = data.filter(
                        o => o.toLowerCase() === autocompleteInput.value.toLowerCase()
                    )[0];
                }
            })
        </script>
    </body>
</html>